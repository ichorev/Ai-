<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>talk with ai</title>
   <style>
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f2f5;
    }

    .container {
        background-color: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        position: relative;
    }

    h1, h2 {
        color: #1a73e8;
        text-align: center;
        margin-bottom: 20px;
    }

    .info-banner {
        background-color: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
        border-left: 4px solid #1a73e8;
    }

    .free-code {
        font-family: monospace;
        font-size: 24px;
        color: #1a73e8;
        background-color: #f8f9fa;
        padding: 10px 20px;
        border-radius: 5px;
        display: inline-block;
        margin: 10px 0;
        border: 2px dashed #1a73e8;
    }

    .contact-link {
        color: #1a73e8;
        text-decoration: none;
        font-weight: bold;
    }

    .contact-link:hover {
        text-decoration: underline;
    }

    #chatbox {
        height: 400px;
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px 0;
        overflow-y: auto;
        border-radius: 8px;
        background-color: #fff;
    }

    .message {
        margin: 8px 0;
        padding: 12px;
        border-radius: 10px;
        max-width: 80%;
        word-wrap: break-word;
        line-height: 1.4;
    }

    .user-message {
        background-color: #e3f2fd;
        margin-left: auto;
        color: #1557b0;
    }

    .bot-message {
        background-color: #f5f5f5;
        margin-right: auto;
        color: #333;
    }

    #gameCanvas {
        border: 2px solid #1a73e8;
        border-radius: 8px;
        margin: 10px auto;
        display: block;
        background-color: #fff;
    }

    .input-area {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    input {
        flex-grow: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
    }

    input:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
    }

    button {
        padding: 12px 24px;
        background-color: #1a73e8;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
    }

    button:hover {
        background-color: #1557b0;
        transform: translateY(-1px);
    }

    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    .account-switcher {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e1e4e8;
    }

    .current-account {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
    }

    .account-menu {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
    }

    .account-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        margin: 5px 0;
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid #e1e4e8;
        transition: all 0.2s;
    }

    .account-item:hover {
        background-color: #e9ecef;
        transform: translateX(5px);
    }

    .account-item.active {
        background-color: #e3f2fd;
        border-left: 4px solid #1a73e8;
    }

    .new-account-button {
        width: 100%;
        margin-top: 10px;
        background-color: #28a745;
    }

    .new-account-button:hover {
        background-color: #218838;
    }

    .usage-info {
        text-align: center;
        margin: 10px 0;
        padding: 10px;
        background-color: #e8f0fe;
        border-radius: 8px;
        font-weight: bold;
    }

    .codes-section {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e1e4e8;
    }

    .code-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin: 8px 0;
        background-color: white;
        border-radius: 6px;
        border: 1px solid #e1e4e8;
        transition: transform 0.2s;
    }

    .code-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .code-item .uses {
        color: #28a745;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 12px;
        background-color: #e8f5e9;
    }

    .code-item .expired {
        color: #dc3545;
        background-color: #fef0f0;
    }

    .game-info {
        text-align: center;
        margin: 15px 0;
        padding: 15px;
        background-color: #e8f0fe;
        border-radius: 8px;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background-color: #e1e4e8;
        border-radius: 4px;
        margin: 10px 0;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background-color: #1a73e8;
        transition: width 0.3s ease;
    }

    .reward-notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #4caf50;
        color: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        z-index: 1000;
        text-align: center;
        animation: popIn 0.3s ease-out;
    }

    .uses-counter {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #1a73e8;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    @keyframes popIn {
        0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }

        .container {
            padding: 15px;
        }

        button {
            padding: 10px 20px;
        }

        .free-code {
            font-size: 20px;
        }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .code-item {
            background-color: #f8f9fa;
        }

        .message {
            border: 1px solid rgba(255,255,255,0.1);
        }
    }
</style>
</head>
<body>
    <div class="container">
        <h1>talk with ai</h1>
        <div class="info-banner">
    <h2>Welcome to AI Chat! ðŸ¤–</h2>
    <p>Here is a free access code to get you started:</p>
    <div class="free-code">TEST5</div>
    <p>This code gives you 5 free uses to experience our AI chat system.</p>
    <p>Want unlimited or more uses? Email us at <a href="mailto:benchorev2@gmail.com" class="contact-link">benchorev2@gmail.com</a></p>
</div>


        <div class="account-switcher">
            <div class="current-account">
                <p>Current Account: <span id="currentAccountId"></span></p>
                <button onclick="toggleAccountMenu()">Switch Account</button>
            </div>
            <div id="accountMenu" class="account-menu">
                <div id="accountsList"></div>
                <button onclick="createNewAccount()" class="new-account-button">Create New Account</button>
            </div>
        </div>

        <div id="accessForm">
            <div class="input-area">
                <input type="text" id="accessCode" placeholder="Enter access code">
                <button onclick="verifyAccess()">Start Chat</button>
            </div>
            <div id="personalCodes" class="codes-section" style="display: none;">
                <h3>Your Access Codes</h3>
                <div id="codesList"></div>
            </div>
        </div>

        <div id="chatInterface" style="display: none;">
            <div class="usage-info">
                Remaining uses: <span id="usageCounter">-</span>
            </div>
            <div id="chatbox"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type your message here...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Play to Earn Rewards! ðŸŽ®</h2>
        <div class="game-info">
            <p>Current Score: <span id="score">0</span></p>
            <div id="progressContainer">
                <p>Progress to Next Reward:</p>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="nextReward">Score 100 points for your first reward!</p>
            </div>
        </div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div style="text-align: center; margin-top: 15px;">
            <button id="startButton" onclick="startGame()">Start Game</button>
        </div>
    </div>

    <script>
        let userId = localStorage.getItem('userId');
        let currentAccessCode = '';
        let gameActive = false;
        let score = 0;
        let playerX = 200;
        let objects = [];
        let currentUsesLeft = 0;

        async function initUser() {
            if (!userId) {
                try {
                    const response = await fetch('/init-user', { method: 'POST' });
                    const data = await response.json();
                    userId = data.userId;
                    localStorage.setItem('userId', userId);
                } catch (error) {
                    console.error('User initialization failed:', error);
                }
            }
            document.getElementById('currentAccountId').textContent = formatUserId(userId);
            document.getElementById('personalCodes').style.display = 'block';
            loadAccounts();
            updatePersonalCodes();
        }

        function formatUserId(id) {
            return id.substring(0, 8) + '...';
        }

        async function loadAccounts() {
            try {
                const response = await fetch('/get-accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateAccountsList(data.accounts);
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        function updateAccountsList(accounts) {
            const accountsList = document.getElementById('accountsList');
            accountsList.innerHTML = '';
            
            accounts.forEach(account => {
                const accountDiv = document.createElement('div');
                accountDiv.className = `account-item ${account.id === userId ? 'active' : ''}`;
                accountDiv.innerHTML = `
                    <span class="account-id">${formatUserId(account.id)}</span>
                    <span class="account-score">Score: ${account.session.score}</span>
                `;
                accountDiv.onclick = () => switchAccount(account.id);
                accountsList.appendChild(accountDiv);
            });
        }

        async function switchAccount(newUserId) {
            try {
                const response = await fetch('/switch-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, newUserId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    userId = newUserId;
                    localStorage.setItem('userId', userId);
                    document.getElementById('currentAccountId').textContent = formatUserId(userId);
                    loadAccounts();
                    updatePersonalCodes();
                    resetChatInterface();
                    toggleAccountMenu();
                }
            } catch (error) {
                console.error('Error switching accounts:', error);
            }
        }

        function resetChatInterface() {
            document.getElementById('chatInterface').style.display = 'none';
            document.getElementById('accessForm').style.display = 'block';
            document.getElementById('chatbox').innerHTML = '';
            currentAccessCode = '';
        }

        async function createNewAccount() {
            try {
                const response = await fetch('/init-user', { method: 'POST' });
                const data = await response.json();
                await switchAccount(data.userId);
            } catch (error) {
                console.error('Error creating new account:', error);
            }
        }

        async function verifyAccess() {
            const accessCode = document.getElementById('accessCode').value.trim();
            
            try {
                const response = await fetch('/verify-access', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessCode, userId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('accessForm').style.display = 'none';
                    document.getElementById('chatInterface').style.display = 'block';
                    currentAccessCode = accessCode;
                    currentUsesLeft = data.usesLeft;
                    updateUsageCounter();
                    addMessage('System: Chat started! How can I help you?', 'bot-message');
                } else {
                    alert('Invalid access code');
                }
            } catch (error) {
                alert('Error verifying access code');
            }
        }

        function updateUsageCounter() {
            const counter = document.getElementById('usageCounter');
            counter.textContent = currentUsesLeft === Infinity ? 'Unlimited' : currentUsesLeft;
            if (currentUsesLeft <= 2 && currentUsesLeft !== Infinity) {
                counter.style.color = '#dc3545';
            } else {
                counter.style.color = 'inherit';
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            if (currentUsesLeft <= 0 && currentUsesLeft !== Infinity) {
                alert('No uses remaining. Please use a different access code.');
                return;
            }

            addMessage('You: ' + message, 'user-message');
            messageInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        accessCode: currentAccessCode,
                        userId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addMessage('AI: ' + data.response, 'bot-message');
                    currentUsesLeft = data.usesLeft;
                    updateUsageCounter();
                    
                    if (currentUsesLeft <= 0) {
                        addMessage('System: You have run out of uses for this code.', 'bot-message');
                    }
                } else {
                    alert(data.error || 'Error sending message');
                }
            } catch (error) {
                alert('Error communicating with server');
            }
        }

        function addMessage(message, className) {
            const chatbox = document.getElementById('chatbox');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + className;
            messageDiv.textContent = message;
            chatbox.appendChild(messageDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        function startGame() {
            if (gameActive) return;
            gameActive = true;
            score = 0;
            objects = [];
            updateScore();
            document.getElementById('startButton').disabled = true;
            gameLoop();
            spawnObjects();
        }

        function gameLoop() {
            if (!gameActive) return;
            
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw player
            ctx.fillStyle = '#1a73e8';
            ctx.fillRect(playerX - 25, 350, 50, 10);
            
            // Update and draw objects
            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                obj.y += 3;
                
                ctx.beginPath();
                ctx.arc(obj.x, obj.y, 10, 0, Math.PI * 2);
                ctx.fillStyle = obj.type === 'good' ? '#4caf50' : '#f44336';
                ctx.fill();
                
                if (obj.y > 350 && obj.y < 370) {
                    if (Math.abs(obj.x - playerX) < 35) {
                        if (obj.type === 'good') {
                            score += 10;
                            updateScore();
                        } else {
                            endGame();
                        }
                        objects.splice(i, 1);
                    }
                }
                
                if (obj.y > 400) {
                    objects.splice(i, 1);
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        function spawnObjects() {
            if (!gameActive) return;
            
            const obj = {
                x: Math.random() * 360 + 20,
                y: 0,
                type: Math.random() > 0.3 ? 'good' : 'bad'
            };
            
            objects.push(obj);
            setTimeout(spawnObjects, 1000);
        }

        async function endGame() {
            gameActive = false;
            document.getElementById('startButton').disabled = false;
            
            try {
                const response = await fetch('/game-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, score })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.newReward) {
                        showRewardNotification(data.newReward);
                        updatePersonalCodes();
                    }
                    
                    if (data.nextReward) {
                        updateProgress(data.totalScore, data.nextReward);
                    }
                }
            } catch (error) {
                console.error('Error submitting score:', error);
            }
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function updateProgress(currentScore, nextReward) {
            const progressFill = document.getElementById('progressFill');
            const nextRewardText = document.getElementById('nextReward');
            
            if (nextReward) {
                const percentage = (currentScore / nextReward.total) * 100;
                progressFill.style.width = `${Math.min(100, percentage)}%`;
                nextRewardText.textContent = 
                    `Score ${nextReward.pointsNeeded} more points for ${nextReward.tier} reward!`;
            } else {
                progressFill.style.width = '100%';
                nextRewardText.textContent = 'All rewards earned!';
            }
        }

        function showRewardNotification(reward) {
            const notification = document.createElement('div');
            notification.className = 'reward-notification';
            notification.innerHTML = `
                <h3>ðŸŽ‰ New Reward Earned! ðŸŽ‰</h3>
                <p>You've earned a ${reward.tier} access code:</p>
                <p style="font-family: monospace; font-size: 1.2em;">${reward.code}</p>
                <p>(${reward.uses} uses)</p>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        async function updatePersonalCodes() {
            const codesList = document.getElementById('codesList');
            if (!codesList) return;
            
            try {
                const response = await fetch('/game-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, score: 0 })
                });
                
                const data = await response.json();
                
                if (data.earnedCodes) {
                    codesList.innerHTML = '';
                    data.earnedCodes.forEach(code => {
                        const codeDiv = document.createElement('div');
                        codeDiv.className = 'code-item';
                        codeDiv.innerHTML = `
                            <div>
                                <div>${code.tier}</div>
                                <div style="font-family: monospace;">${code.code}</div>
                            </div>
                            <div class="uses ${code.uses <= 0 ? 'expired' : ''}">
                                ${code.uses === Infinity ? 'Unlimited' : `${code.uses} uses`}
                            </div>
                        `;
                        codesList.appendChild(codeDiv);
                    });
                }
            } catch (error) {
                console.error('Error updating personal codes:', error);
            }
        }

        function toggleAccountMenu() {
            const menu = document.getElementById('accountMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Event Listeners
        document.getElementById('gameCanvas').addEventListener('mousemove', (e) => {
            if (!gameActive) return;
            
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            playerX = Math.max(25, Math.min(375, e.clientX - rect.left));
        });

        // Touch support for mobile
        document.getElementById('gameCanvas').addEventListener('touchmove', (e) => {
            if (!gameActive) return;
            e.preventDefault();
            
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            playerX = Math.max(25, Math.min(375, touch.clientX - rect.left));
        }, { passive: false });

        // Enter key handlers
        document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('accessCode')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                verifyAccess();
            }
        });

        // Close account menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('accountMenu');
            const switcher = document.querySelector('.account-switcher');
            if (!switcher.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        // Initialize everything
        window.addEventListener('load', initUser);
    </script>
</body>
</html>
